name: CI

on:
  pull_request:
    branches:
      - main

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.5"
          cache-dependency-path: go.sum

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        run: |
          cd frontend
          npm ci
          cd ..

      - name: Check Go code formatting
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "❌ Code is not formatted. Run 'go fmt ./...' to fix."
            gofmt -s -d .
            exit 1
          else
            echo "✅ Code is properly formatted"
          fi

      - name: Run Go unit tests
        run: go test -short -v ./...

      - name: Build frontend
        run: |
          cd frontend
          npm run build
          cd ..

  build:
    name: Build
    runs-on: ${{ matrix.os }}
    needs: test
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux/amd64
          - os: macos-15
            platform: darwin/arm64
          - os: windows-latest
            platform: windows/amd64

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v6
        with:
          go-version: "1.25.5"
          cache-dependency-path: go.sum

      - name: Set up Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Build frontend
        run: |
          cd frontend
          npm ci
          npm run build
          cd ..

      - name: Install Wails CLI
        run: |
          go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install system dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libgtk-3-dev \
            libwebkit2gtk-4.1-dev \
            libappindicator3-dev \
            librsvg2-dev \
            patchelf \
            pkg-config
          # Create symlink for webkit2gtk-4.0 if it doesn't exist (Wails looks for 4.0)
          for PKG_DIR in /usr/lib/x86_64-linux-gnu/pkgconfig /usr/lib/pkgconfig /usr/share/pkgconfig; do
            if [ -d "$PKG_DIR" ] && [ -f "${PKG_DIR}/webkit2gtk-4.1.pc" ] && [ ! -f "${PKG_DIR}/webkit2gtk-4.0.pc" ]; then
              sudo ln -sf "${PKG_DIR}/webkit2gtk-4.1.pc" "${PKG_DIR}/webkit2gtk-4.0.pc"
              echo "Created symlink: ${PKG_DIR}/webkit2gtk-4.0.pc -> webkit2gtk-4.1.pc"
            fi
          done
          pkg-config --exists webkit2gtk-4.0 && echo "✓ webkit2gtk-4.0 found" || echo "⚠ webkit2gtk-4.0 not found, but continuing..."

      - name: Verify Windows dependencies
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $webview2Path = "C:\Program Files (x86)\Microsoft\EdgeWebView\Application\*\msedgewebview2.exe"
          if (Test-Path $webview2Path) {
            Write-Host "✓ WebView2 runtime found"
          } else {
            Write-Host "⚠ WebView2 runtime not found, but Wails may still work if Edge is installed"
          }
          go version
          $env:CGO_ENABLED = "1"
          Write-Host "✓ CGO enabled for Windows build"

      - name: Build with Wails
        run: |
          wails build -platform ${{ matrix.platform }} -clean

      - name: Verify build artifact
        run: |
          if [[ "${{ matrix.os }}" =~ ^macos- ]]; then
            test -d build/bin/pubsub-gui.app && echo "✅ macOS app bundle created" || (echo "❌ macOS app bundle not found" && exit 1)
          elif [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            test -f build/bin/pubsub-gui.exe && echo "✅ Windows executable created" || (echo "❌ Windows executable not found" && exit 1)
          else
            test -f build/bin/pubsub-gui && echo "✅ Linux binary created" || (echo "❌ Linux binary not found" && exit 1)
          fi
